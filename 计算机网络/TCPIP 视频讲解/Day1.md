## Day1

### 1.概述：

##### 分层

![image-20200905105231494](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905105231494.png)

- 应用层：处理特定的应用细节

- 运输层：为两台主机上的应用程序提供端到端的通讯

- 网络层：处理分组在网络中的活动，例如分组选路

- 链路层：处理与电缆的物理接口细节

##### 实例：运行FTP的两台主机

![image-20200905105155937](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905105155937.png)

- 大多数的网络应用程序都被设计成客户-服务器模式。
- 双方都有对应的一个或多个协议进行通讯
- 应用程序通常是用户进程，而下三层一般在内核执行
- 应用层关系应用程序的细节，下三层处理通讯细节

##### 通过路由器连接的两个网络

![image-20200905105127664](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905105127664.png)

- 端系统：两边的两台主机
- 中间系统：中间的路由器
- 应用层和传输层使用端到端(end-to-end)协议
- 网络层提供的是逐跳(hop-by-hop)协议
- 网络ip提供的是一种不可靠的服务，他只是尽可能快的把分组从源结点送到目的结点，但不提供可靠性保障
- TCP在不可靠的IP层上提供一个可靠的传输层
  - 为了提供这种可靠的服务， TCP采用了超时重传、发送和接收端到端的确认分组等机制。
- 互联网的目的之一就是在应用程序中隐藏所有的物理细节
  - 应用层不关心一台主机是在以太网上，而另一台主机是在令牌环网上，它们通过路由器进行互连，其应用层仍然是一样的。

构造互连网最简单的方法是把两个或多个网络通过路由器进行连接。它是一种特殊的用于网络互连的硬件盒。路由器的好处是为不同类型的物理网络提供连接：以太网、令牌环网、点对点的链接和FDDI（光纤分布式数据接口）等等。

连接网络的另一个途径是使用网桥。网桥是在链路层上对网络进行互连，而路由器则是在网络层上对网络进行互连。网桥使得多个局域网（ LAN）组合在一起，这样对上层来说就好像是一个局域网。

##### TCP/IP协议族中不同层次的协议

<img src="C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905110451284.png" alt="image-20200905110451284" style="zoom:80%;" />

- TCP使用不可靠的IP服务，并提供一种可靠的传输层服务
- UDP为应用程序发送和接受数据报，和TCP不同，UDP是不可靠的
  - 语音，视频可以不用重传，使用UDP
- IP是网络层上的主要协议，同时被TCP和UDP使用
- ICP是IP协议的附属协议
  - I P层用它来与其他主机或路由器交换错误报文和其他重要信息。
  - 尽管ICMP主要被IP使用，但应用程序(Ping和Traceroute)也有可能访问它。

- IGMP是Internet组管理协议。它用来把一个UDP数据报多播到多个主机。
- ARP（地址解析协议）和RARP（逆地址解析协议）是某些网络接口（如以太网和令牌环网）使用的特殊协议，用来转换 I P层和网络接口层使用的地址。

##### 封装

当应用程序用 T C P传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）

![image-20200905111111610](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905111111610.png)

- 以太网数据帧的物理特性是其长度必须在 46～1500字节之间。
- 每一层数据的首部中加入某种标识，以表明数据属于哪一层。
  - 以太网帧首部有一个16bit的帧类型域(ip,arp,rarp)
  - IP在首部中存入一个长度为8bit的数值，称为协议域(icmp,igmp,tcp,udp,esp,gre)
  - TCP和UCP都用一个16bit的端口号来表示不同的应用程序(ftp,telnet,http)

##### 分用

当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作分用。

![image-20200905111727695](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905111727695.png)

##### 端口号

- 服务器一般都是提供知名端口号来识别的(ftp:21,telnet:23)(1-1023)
- 客户端口号又称作临时端口号(即存在时间很短暂)(1024-5000)
  - 客户端通常对它所使用的端口号并不关心，只需保证该端口号在本机上是唯一的就可以了。
  - 是因为它通常只是在用户运行该客户程序时才存在，而服务器则只要主机开着的，其服务就运行。
- 大于5000的端口号是为其他服务器预留的
- 通常TCP和UDP的缺省临时端口号从32768开始。

##### 实现过程

从历史上看，软件是随同4.x BSD系统的网络版一起发布的。它的源代码是许多其他实现的基础。

<img src="C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905112614373.png" alt="image-20200905112614373" style="zoom:80%;" />

### 2.链路层：

##### 以太网和IEEE802封装

以太网

- 以太网这个术语一般是指数字设备公司、英特尔公司和Xerox公司在1982年联合公布的一个标准
- 它采用一种称为CSMA/CD的媒体接入方法
- 标准以太网的速率为10Mb/s，MAC地址为48bit

IEEE802封装

- 802.3针对整个CSMA/CD网络
- 802.4针对令牌总线网络
- 802.5针对令牌环网络
- 这三者的共同特性由802.2标准来定义，那就是802网络共有的逻辑链路控制LLC
- 不幸的是，802.2和802.3定义了一个与以太网不同的帧格式。

##### IEEE 802.2/802.3和以太网的封装格式

![image-20200905113639650](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905113639650.png)

- 802定义的有效长度值与以太网的有效类型值无一相同，这样，就可以对两种帧格式进行区分
- 在TCP/IP世界中，以太网IP数据报的封装是在RFC 894[Hornig 1984]中定义的，IEEE 802网络的I P数据报封装是在RFC 1042[Postel and Reynolds 1988]中定义的。
- 最常使用的封装格式是 RFC 894定义的格式。
- 类型0800为ip，0806为arp
- 802.3标准定义的帧和以太网的帧都有最小长度要求。 802.3规定数据部分必须至少为 38字节，而对于以太网，则要求最少要有46字节。为了保证这一点，必须在不足的空间插入填充（pad）字节。

##### 环回接口

大多数的产品都支持环回接口，以允许运行在同一台主机上的客户程序和服务器程序通过TCP/IP进行通信。A类网络号127就是为环回接口预留的。一般把IP地址127.0.0.1分配给这个接口，并命名为localhost。一个传给环回接口的IP数据报不能在任何网络上出现。

![image-20200905115051519](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905115051519.png)



- 传给环回地址（一般是127.0.0.1）的任何数据均作为IP输入。
- 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上。这是因为广播传送和多播传送的定义包含主机本身。
-  任何传给该主机IP地址的数据均送到环回接口。

##### MTU和路径MTU

- 以太网和802.3对数据帧的长度都有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称作MTU，最大传输单元。
- 如果IP层有一个数据报要传，而且数据的长度比链路层的MTU还大，那么IP层就需要进行分片，把数据报分成若干片，这样每一片都小于MTU。
- 点到点的链路层（如SLIP和PPP）的MTU并非指的是网络媒体的物理特性。相反，它是一个逻辑限制，目的是为交互使用提供足够快的响应时间。
- 两台通信主机路径中的最小MTU。它被称作路径MTU。
- 两台主机之间的路径MTU不一定是个常数。它取决于当时所选择的路由。而选路不一定是对称的。因此路径MTU在两个方向上不一定是一致的。
- MTU是在出方向时计算

### 第3章 IP：网际协议

- IP是TCP/IP协议族中最为核心的协议。所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输

- IP提供不可靠、无连接的数据报传送服务
- 不可靠的意思是它不能保证IP数据报能成功地到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供（如TCP）。
- 无连接这个术语的意思是 I P并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报（先是A，然后是B），每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。
- 介绍两个有用的命令：ifconfig和netstat。

##### IP首部

普通的IP首部长为20个字节，除非含有选项字段。

![image-20200905122430483](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905122430483.png)

- 4个字节的32 bit值以下面的次序传输：首先是 0～7 bit，其次8～15 bit，然后1 6～23 bit，最后是24~31 bit。这种传输次序称作big endian字节序。由于T C P / I P首部中所有的二进制整数在网络中传输时都要求以这种次序，因此它又称作网络字节序。以其他形式存储二进制整数的机器，如little endian格式，则必须在传输数据之前把首部转换成网络字节序。
- 目前的协议版本号是4，因此IP有时也称作IPv4。
- 首部长度指的是首部占32bit字的数目，包括任何选项，单位是4字节。由于它是一个4比特字段，因此首部最长为60个字节。普通IP数据报（没有任何选择项）字段的值是5。
- 服务类型（TOS）字段包括一个3bit的优先权子字段（现在已被忽略），4bit的TOS子字段和1 bit未用位但必须置0。4bit的TOS分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。4bit中只能置其中1bit。如果所有4bit均为0，那么就意味着是一般服务。
- 总长度字段是指整个IP数据报的长度，以字节为单位。利用首部长度字段和总长度字段，就可以知道IP数据报中数据内容的起始位置和长度。由于该字段长16比特，所以 I P数据报最长可达 65535字节
- 标识字段唯一地标识主机发送的每一份数据报。通常每发送一份报文它的值就会加 1。
- 标志字段，占3位，但目前只有两位有意义。
  - 标志字段中的最低位为MF（More Fragment）。MF=1即表示后面“还有分片”的数据报。MF=0表示这已是若干数据报片中的最后一个。
  - 标志字段中间的一位记为DF（Don't Fragment），意思是“不能分片”。只有当DF=0时才允许分片。
- 片偏移字段，占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。片偏移以8个字节为偏移单位。也就是说，每个分片的长度一定是8字节（64位）的整数倍。
- TTL生存时间字段设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，它的值就减去1。当该字段的值为0时，数据报就被丢弃，并发送ICMP报文通知源主机。
- 协议字段：表明数据属于哪一层，根据它可以识别是哪个协议向IP传送数据。
- 首部检验和字段是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码。
- 每一份IP数据报都包含源IP地址和目的IP地址。它们都是32bit的值。
- 最后一个字段是任选项，是数据报中的一个可变长的可选信息。

##### IP首部的选项

• 安全和处理限制（用于军事领域，详细内容参见 RFC 1108[Kent 1991]） 

• 记录路径（让每个路由器都记下它的 I P地址，见7 . 3节）

• 时间戳（让每个路由器都记下它的 I P地址和时间，见7 . 4节）

• 宽松的源站选路（为数据报指定一系列必须经过的 I P地址，见8 . 5节）

• 严格的源站选路（与宽松的源站选路类似，但是要求只能经过指定的这些地址，不能经过其他的地址）。

这些选项很少被使用，并非所有的主机和路由器都支持这些选项。

选项字段一直都是以32bit作为界限，在必要的时候插入值为0的填充字节。这样就保证IP首部始终是32bit的整数倍（这是首部长度字段所要求的）。

##### IP路由选择

首先考虑一个简单的例子：我们的主机bsdi有一个IP数据报要发送给主机sun。双方都在同一个以太网上。

![image-20200905125909393](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905125909393.png)

现在来看另一个例子：主机bsdi有一份IP数据报要传到ftp.uu.net主机上，它的IP地址是192.48.96.9。

![image-20200905125920290](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905125920290.png)

数据报中的IP地址一直都是不变的。链路层地址(MAC地址)却在不断变化，始终

指的是下一站的链路层地址。

##### 特殊情况的IP地址

![image-20200905130431307](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200905130431307.png)

- 0表示所有的比特位全为0；- 1表示所有的比特位全为 1；netid、subnetid和hostid分别表示不为全0或全1的对应字段。子网号栏为空表示该地址没有进行子网划分。
- 表的头两项是特殊的源地址，中间项是特殊的环回地址，最后四项是广播地址。
- 表中的头两项，网络号为0，如主机使用BOOTP协议确定本机IP地址时只能作为初始化过程中的源地址出现。