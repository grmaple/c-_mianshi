## 第三章

### 计算机体系结构及内存分层体系

操作系统如何管理物理内存

CPU，内存，外设

内存的层次结构

寄存器

cache

主存(物理内存)

磁盘(虚拟内存)

##### 操作系统管理内存的目标

抽象：逻辑地址空间

保护：独立地址空间

共享：访问相同内存

虚拟：更多地址空间

##### 在操作系统中管理内存的不同方法

- 程序重定位
- 分段
- 分页
- 虚拟内存
- 按需分页虚拟内存

### 地址空间和地址生成

##### 地址空间定义

物理地址空间：硬件支持的地址空间

逻辑地址空间：一个运行的程序所拥有的内存访问

逻辑地址空间和物理地址空间需要映射关系

##### 地址空间生成

逻辑地址生成：程序中的变量是逻辑地址，在汇编后将变量转变成逻辑地址，然后链接，然后载入(程序重定位)，这时候还是逻辑地址。

物理地址生成：MMU(内存管理单元)将逻辑地址映射到物理地址

1.CPU执行某条指令时，ALU部件需要这条指令的内容，参数是逻辑地址

2.MMU查找该逻辑地址的映射表

3.ALU发送对在物理地址的内存内容的请求

4.内存发送物理地址内存的内容给CPU

操作系统起到什么作用？

操作系统需要建立逻辑地址和物理地址之间的映射

##### 地址安全检查

操作系统需要确保每个程序的有效访问地址空间。

这个地址空间包含起始地址，长度。

CPU执行某条指令，先判断逻辑地址是否满足限制(界限寄存器)，不满足就发出内存异常，满足则去寻找物理地址。

### 连续内存分配

##### 内存碎片问题

空闲内存不能被利用

外部碎片：在分配单元间的未使用内存

内部碎片：在分配单元中的未使用内存

##### 分区的动态分配

简单的内存管理方法：

- 运行前：当一个程序准许运行在内存中时，分配一个连续的区间
- 运行中：分配一个连续的内存区间给运行的程序以访问数据

内存的动态分配策略：

- 首次适配
  - 简单实现
  - 需要空闲块按地址排序，分配需要寻找一个合适的分区，重分配需要检查，看是否自由分区能合并于相邻的空闲分区
  - 优势：简单，易于产生更大空闲块，向着地址空间的结尾
  - 劣势：容易产生外部碎片，不确定性
- 最优适配
  - 为了避免分割大空闲块
  - 为了最小化外部碎片产生的尺寸
  - 空闲块按尺寸排列，分配需要寻找一个合适的分区，重分配需要搜索并合并于相邻的空闲分区
  - 优势：当大部分分配是小尺寸时非常有效，比较简单
  - 劣势：外部碎片，重分配慢，易产生很多没用的微小碎片
- 最差适配
  - 为了避免有太多微小碎片
  - 空闲块按尺寸排列，分配很快(获得最大的分区)，重分配需要合并于相邻的空闲分区
  - 优势：假如分配是中等尺寸效果最好，比较简单
  - 劣势：外部碎片，重分配慢，易于破碎大的空闲块以致大分区无法被分配

##### 压缩式碎片整理

进一步减少碎片的问题。

重置程序以合并孔洞

要求所有程序是动态可重置的

通过挪动程序位置，以合并碎片，紧凑

什么时候把程序从一个地方挪动到另一个地方?

内存拷贝开销大不大？

##### 交换式碎片整理

引入磁盘，进行换入换出。

运行程序需要更多的内存

抢占等待的程序&回收它们的内存

选择哪个程序换出到磁盘?

什么时候换入换出？

换入换出开销大不大？