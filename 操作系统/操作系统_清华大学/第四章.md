## 第四章

非连续内存分配

为什么需要非连续内存分配？

分段

分页

页表

##### 为什么需要非连续内存分配？

连续内存分配的缺点：

- 分配给一个程序的物理内存是连续的
- 内存利用率较低
- 有内碎片，外碎片问题

非连续内存分配的优点：

- 一个程序的物理地址空间是非连续的
- 更好的内存利用和管理
- 允许共享代码和数据
- 支持动态加载和动态链接

非连续内存分配的优点：

- 如何建立虚拟地址和物理地址之间的转换？
  - 软件方案
  - 硬件方案

软件开销很大，尽量用硬件实现

两种硬件方案：分段，分页

### 分段

- 程序的分段地址空间

- 分段寻址方案

分段：更好的分离和共享

逻辑地址空间是连续的，但是实际是分散到多个物理地址空间。

需要一种映射机制。

怎么使用硬件进行分段寻找？

段访问机制

一个段：一个内存卡，一个逻辑地址空间

程序访问内存地址需要一个二维的二元组(s:段号，addr:段内偏移)

![image-20200906150119603](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906150119603.png)

段寄存器+地址寄存器实现方案

单地址实现方案

段表里面存储着起始地址和限制长度，段号就是段表的索引。

通过段号，在段表中寻找物理地址中该段的起始地址。

段表由操作系统建立。

### 分页

- 分页地址空间

- 页寻址方案

分段和分页的区别是段尺寸。

段大小是可以变的，页帧大小是固定的。

划分物理内存至固定大小的帧(物理页)。

划分逻辑地址空间至相同大小的页(逻辑页)。

建立方案：转换逻辑地址为物理地址

页表

快表TLB

##### 页帧

一个内存物理地址是一个二元组(f:帧号，共有2^F帧，o:帧内偏移，每帧有2^S字节)

物理地址=2^S*f+o

地址计算：16bit的地址空间，9bit(512byte)大小的页帧。因此页帧个数有7bit。

物理地址=(3,6)=2^9*3+6=1542

##### 页

一个程序的逻辑地址空间被划分至相同大小的页。

页内偏移大小=帧内偏移大小。

一个逻辑地址是一个二元组p:页号，共有2^P页，o:页内偏移，每页有2^S字节)

物理地址=2^S*p+o

##### 页寻址机制

页表保存了逻辑地址和物理地址之间的映射关系

索引是页号，内容是帧号。

页表基址：从哪里开始查。

通过逻辑地址的页号，查页表，找到物理地址的帧号，然后逻辑地址的页内偏移=物理地址的帧内偏移。

页表也是由操作系统建立的。

页映射到帧

页是连续的虚拟内存

帧是非连续的物理内存

不是所有页都有对应的帧。

### 页表

##### 页表概述

每个运行的程序都有一个页表

属于程序运行状态：会动态变化

PTBR：页表基址寄存器

页表结构

![image-20200906152342952](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906152342952.png)

分页机制的性能问题

时间：访问一个内存单元需要2次内存访问--缓存

- 一次用于获取页表项
- 一次用于访问数据

空间：页表可能非常大--多级页表

##### 转换后备缓冲区TLB

CPU中的快表TLB

缓存近期访问的页帧转换表项

- TLB使用关联内存实现，具备快速访问特性
- 如果TLB命中，物理页可以很快被获取
- 如果TLB没用命中，对应的表项被更新到TLB(先去内存访问页表)

##### 二级/多级页表

二级页表

页表分成一级页表和二级页表

逻辑地址分成一级页表号+二级页表号+页内偏移地址

虽然需要多次查询页表，时间开销加大了，

但是如此可以使得不存在映射关系的页表项就不必占用内存了(对应的二级页表可以不用建立)，空间开销减小了

多级页表

通过把页号分为k个部分，来实现多级间接页表。建立页表。

##### 反向页表

页表项不和逻辑地址空间有直接关系，让其大小不受限于逻辑地址，而是和物理地址有关系。

大地址空间问题，前向映射表变得很繁琐。

基于页寄存器的方案。

索引是帧号，内容是页号。

由于访问查找的比对是根据页号，所以只能从第一个页帧号开始，一个一个做比对。

利：转换表的大小相当于物理内存来说很小，跟逻辑地址空间大小无关

弊：需要的信息对调了，即根据帧号找页号。那么如何转换回来？即根据页号找帧号。在需要在反向页表中搜索需要的页号。

基于关联内存的方案。

如果帧数较小，页寄存器可以被放置在关联内存中。

在关联内存中查找页号：成功：帧号被提取，失败：页错误异常

限制因素：大量的关联内存非常昂贵，难以在单个时钟周期内完成，耗电。

基于哈希查找的方案

输入页表号，输出页帧号。

有可能会有哈希冲突。所以最好加个PID