



### ARP

- 当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的接口的。**设备驱动程序从不检查IP数据报中的目的IP地址。**
- 地址解析为这两种不同的地址形式提供映射：32bit的IP地址和数据链路层使用的任何类型的地址。 
- ARP为IP地址到对应的硬件地址之间提供动态映射。我们之所以用动态这个词是因为这个过程是自动完成的，一般应用程序用户或系统管理员不必关心。
- RARP是被那些没有磁盘驱动器的系统使用（一般是无盘工作站或 X终端），它需要系统管理员进行手工设置。

##### 一个例子

![image-20200906100358678](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906100358678.png)

1) 应用程序FTP客户端调用函数gethostbyname把主机名（bsdi）转换成32bit的IP地址。这个函数在DNS（域名系统）中称作解析器。这个转换过程或者使用DNS，或者在较小网络中使用一个静态的主机文件（/etc/hosts）。

2) FTP客户端请求TCP，用得到的IP地址建立连接。

3) TCP发送一个连接请求分段到远端的主机，即用上述IP地址发送一份IP数据报

4) 如果目的主机在本地网络上（如以太网、令牌环网或点对点链接的另一端），那么IP数据报可以直接送到目的主机上。如果目的主机在一个远程网络上，那么就通过IP选路函数来确定位于本地网络上的下一站路由器地址，并让它转发IP数据报。在这两种情况下，IP数据报都是被送到位于本地网络上的一台主机或路由器。

5) 假定是一个以太网，那么发送端主机必须把32bit的IP地址变换成48bit的以太网地址。从逻辑Internet地址到对应的物理硬件地址需要进行翻译。这就是ARP的功能。ARP本来是用于广播网络的，有许多主机或路由器连在同一个网络上。

6) ARP发送一份称作ARP请求的以太网数据帧给以太网上的每个主机。这个过程称作广播(二层广播)，如图中的虚线所示。ARP请求数据帧中包含目的主机的IP地址（主机名为bsdi），其意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址。” 

7) 目的主机的ARP层收到这份广播报文后，识别出这是发送端在寻问它的IP地址，于是发送一个ARP应答(二层单播)。这个ARP应答包含IP地址及对应的硬件地址。

8) 收到ARP应答后，使ARP进行请求—应答交换的IP数据报现在就可以传送了。

9) 发送IP数据报到目的主机。

##### ARP背后有一个基本概念

那就是网络接口有一个硬件地址（一个48bit的值，标识不同的以太网或令牌环网络接口）。在硬件层次上进行的数据帧交换必须有正确的接口地址。但是，TCP/IP有自己的地址：32bit的IP地址。**知道主机的IP地址并不能让内核发送一帧数据给主机。**内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据。 ARP的功能是在32 bit的IP地址和采用不同网络技术的硬件地址之间提供动态映射。

##### ARP高速缓存

pc上

arp -a//显示高速缓存中所有的内容

arp -d//清除高速缓存中所有的内容

路由器上

show arp//显示高速缓存中所有的内容

clear arp//清除高速缓存中所有的内容

#####  ARP的分组格式

![image-20200906102342421](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906102342421.png)

以太网报头中的前两个字段是以太网的源地址和目的地址。目的地址为全 1的特殊地址是广播地址。电缆上的所有以太网接口都要接收广播的数据帧。

两个字节长的以太网帧类型表示后面数据的类型。对于 A R P请求或应答来说，该字段的值为0x0806。

形容词hardware (硬件)和protocol (协议)用来描述ARP分组中的各个字段。例如，一个ARP请求分组询问协议地址（这里是 IP地址）对应的硬件地址（这里是以太网地址）。

硬件类型字段表示硬件地址的类型。它的值为1即表示以太网地址。协议类型字段表示要映射的协议地址类型。它的值为0x0800即表示IP地址。它的值与包含IP数据报的以太网数据帧中的类型字段的值相同，这是有意设计的。

接下来的两个1字节的字段，硬件地址长度和协议地址长度分别指出硬件地址和协议地址的长度，以字节为单位。对于以太网上IP地址的ARP请求或应答来说，它们的值分别为6和4。

操作op字段指出四种操作类型，它们是ARP请求（值为1）、ARP应答（值为2）、RARP请求（值为3）和RARP应答（值为4）。这个字段必需的，因为ARP请求和ARP应答的帧类型字段值是相同的。

接下来的四个字段是发送端的硬件地址（在本例中是以太网地址）、发送端的协议地址（IP地址）、目的端的硬件地址和目的端的协议地址。

##### ARP代理

如果ARP请求是从一个网络的主机发往另一个网络上的主机，那么连接这两个网络的路由器就可以回答该请求，这个过程称作委托 ARP或ARP代理(ProxyARP)。这样可以欺骗发起ARP请求的发送端，使它误以为路由器就是目的主机，而事实上目的主机是在路由器的“另一边”。路由器的功能相当于目的主机的代理，把分组从其他主机转发给它。

通过两个物理网络之间的路由器可以互相隐藏物理网络。

ARP后者优先。

##### 免费ARP

我们可以看到的另一个ARP特性称作免费ARP (gratuitous ARP)。它是指主机发送ARP查找自己的IP地址。通常，它发生在系统引导期间进行接口配置的时候。

免费ARP可以有两个方面的作用：

1) 一个主机可以通过它来确定另一个主机是否设置了相同的IP地址。主机bsdi并不希望对此请求有一个回答。但是，如果收到一个回答，那么就会在终端日志上产生一个错误消息“以太网地址：a: b:c:d:e:f发送来重复的IP地址”。这样就可以警告系统管理员，某个系统有不正确的设置。

2) 如果发送免费ARP的主机正好改变了硬件地址（很可能是主机关机了，并换了一块接口卡，然后重新启动），那么这个分组就可以使其他主机高速缓存中旧的硬件地址进行相应的更新。一个比较著名的ARP协议事实是，如果主机收到某个IP地址的ARP请求，而且它已经在接收者的高速缓存中，那么就要用ARP请求中的发送端硬件地址（如以太网地址）对高速缓存中相应的内容进行更新。主机接收到任何ARP请求都要完成这个操作（ARP请求是在网上广播的，因此每次发送ARP请求时网络上的所有主机都要这样做）。

通过发送含有备份硬件地址和故障服务器的 I P地址的免费A R P请求，使得备份文件服务器可以顺利地接替故障服务器进行工作。这使得所有目的地为故障服务器的报文都被送到备份服务器那里，客户程序不用关心原来的服务器是否出了故障。

一个主机收到ARP报文，不止看目的IP是不是自己，也会看源IP，然后更新ARP表。

### ICMP

- ICMP经常被认为是IP层的一个组成部分。**它传递差错报文以及其他需要注意的信息。**ICMP报文通常被IP层或更高层协议（TCP或UDP）使用。**一些ICMP报文把差错报文返回给用户进程。**

- ICMP报文是在IP数据报内部被传输的

- 所有报文的前4个字节都是一样的，但是剩下的其他字节则互不相同。下面我们将逐个介绍各种报文格式。

  - 类型字段可以有15个不同的值，以描述特定类型的ICMP报文。
  - 某些ICMP报文还使用代码字段的值来进一步描述不同的条件。
  - 检验和字段覆盖整个ICMP报文。使用的算法与IP首部检验和算法相同。ICMP的检验和是必需的。

  ![image-20200906110310153](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906110310153.png)

![image-20200906110811639](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906110811639.png)

- 各种类型的ICMP报文如图所示，不同类型由报文中的类型字段和代码字段来共同决定。
- 图中的最后两列表明ICMP报文是一份查询报文还是一份差错报文。
- 当发送一份ICMP差错报文时，报文始终包含IP的首部和产生ICMP差错报文的IP数据报的前8个字节。这样，接收ICMP差错报文的模块就会把它与某个特定的协议（根据IP数据报首部中的协议字段来判断）和用户进程（根据包含在IP数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号来判断）联系起来。

##### ICMP差错报文

1) ICMP差错报文（但是，ICMP查询报文可能会产生ICMP差错报文）。

2) 目的地址是广播地址或多播地址的I P数据报。

3) 作为链路层广播的数据报。

4) 不是IP分片的第一片(没有端口号)。

5) 源地址不是单个主机的数据报。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址。

这些规则是为了防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴。

![image-20200906112459597](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906112459597.png)

![image-20200906112523154](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906112523154.png)

路由器返回ICMP差错报文，但是应用层不一定会处理这个报文。

### PING

- “ping”这个名字源于声纳定位操作。 Ping程序由Mike Muuss编写，目的是为了测试另一台主机是否可达。该程序发送一份ICMP回显请求报文给主机，并等待返回ICMP回显应答
- 可以用 Ping程序来确定问题出在哪里。 Ping程序还能测出到这台主机的往返时间，以表明该主机离我们有“多远”。
- 一台主机的可达性可能不只取决于IP层是否可达，还取决于使用何种协议以及端口号。

##### Ping程序

我们称发送回显请求的 p i n g程序为客户，而称被 p i n g的主机为服务器。大多数的 T C P / I P实现都在内核中直接支持 P i n g服务器—这种服务器不是一个用户进程。

![image-20200906113920919](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906113920919.png)

8，0请求回显，PING请求
0，0回显应答，PING应答

对于其他类型的ICMP查询报文，服务器必须响应标识符和序列号字段。另外，客户发送的选项数据必须回显，假设客户对这些信息都会感兴趣。

Unix系统在实现ping程序时是把ICMP报文中的标识符字段置成发送进程的ID号。这样即使在同一台主机上同时运行了多个ping程序实例，ping程序也可以识别出返回的信息。序列号从0开始，每发送一次新的回显请求就加 1。ping程序打印出返回的每个分组的序列号，允许我们查看是否有分组丢失、失序或重复。

Windows下，不管开多少个窗口ping的标识符都是相同的，而且每增加一个出去的ping包，序列号增加256.

##### IP记录路由选项

大多数不同版本的 ping程序都提供-R选项，以提供记录路由的功能。它使得ping程序在发送出去的IP数据报中设置IP RR选项（该IP数据报包含ICMP回显请求报文）。这样，每个处理该数据报的路由器都把它的IP地址(出口)放入选项字段中。当数据报到达目的端时， IP地址清单应该复制到ICMP回显应答中，这样返回途中所经过的路由器地址也被加入清单中。当ping程序收到回显应答时，它就打印出这份IP地址清单。

源端主机生成RR选项，中间路由器对RR选项的处理，以及把ICMP回显请求中的RR清单复制到ICMP回显应答中，所有这些都是选项功能。幸运的是，现在的大多数系统都支持这些选项功能，只是有一些系统不把ICMP请求中的IP清单复制到ICMP应答中。

最大的问题是IP首部中只有有限的空间来存放IP地址。也就是说只能存放9个IP地址。而且因为是选项功能，所以需要途径的每一个路由器都打开选项功能。

IP数据报中的记录路由选项结构

![image-20200906115352241](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906115352241.png)

code是一个字节，指明IP选项的类型。对于 RR选项来说，它的值为 7。len是RR选项总字节长度，在这种情况下为 39(最多可以记录 9个I P地址)

ptr称作指针字段。它是一个基于1的指针，指向存放下一个IP地址的位置。它的最小值为4，指向存放第一个IP地址的位置。随着每个IP地址存入清单， ptr的值分别为8，12，16，最大到36。当记录下9个IP地址后，ptr的值为4 0，表示清单已满。

路由器记录出口IP地址。

##### IP时间戳选项

![image-20200906120258350](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906120258350.png)

时间戳选项的代码为 0x44。其他两个字段len和ptr与记录路由选项相同：选项的总长度（一般为36或40）和指向下一个可用空间的指针（ 5，9，13等）。接下来的两个字段是 4 bit的值：OF表示溢出字段，FL表示标志字段。时间戳选项的操作根据标志字段来进行.

![image-20200906120339919](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906120339919.png)

时间戳的取值一般为自 UTC午夜开始计的毫秒数，与ICMP时间戳请求和应答相类似。如果路由器不使用这种格式，它就可以插入任何它使用的时间表示格式，但是必须打开时间戳中的高位以表明为非标准值。

与我们遇到的记录路由选项所受到的限制相比，时间戳选项遇到情况要更坏一些。如果我们要同时记录 I P地址和时间戳（标志位为1），那么就可以同时存入其中的四对值。只记录时间戳是没有用处的，因为我们没有标明时间戳与路由器之间的对应关系（除非有一个永远不变的拓扑结构）。

### Traceroute

用于追踪路由。

Traceroute程序可以让我们看到IP数据报从一台主机传到另一台主机所经过的路由。Traceroute程序还可以让我们使用IP源路由选项。

##### Traceroute和IP记录路由选项的比较

- 首先，并不是所有的路由器都支持记录路由选项。
- 其次，记录路由一般是单向的选项。这样使得记录下来的IP地址翻了一番。
- 最后，IP首部中留给选项的空间有限，不能存放当前大多数的路径。

##### IP源站选路选项

源站路由选项的实际称呼为“源站及记录路由”（对于宽松的源站选路和严格的源站选路，分别用LSRR和SSRR表示），这是因为在数据报沿路由发送过程中，对IP地址清单进行了更新。

- 发送主机从应用程序接收源站路由清单，将第 1个表项去掉（它是数据报的最终目的地址），将剩余的项移到1个项中（如图8 - 6所示），并将原来的目的地址作为清单的最后一项。指针仍然指向清单的第 1项（即，指针的值为4）。 
- 每个处理数据报的路由器检查其是否为数据报的最终地址。如果不是，则正常转发数据报（在这种情况下，必须指明宽松源站选路，否则就不能接收到该数据报）。 
- 如果该路由器是最终目的，且指针不大于路径的长度，那么( 1)由p t r所指定的清单中的下一个地址就是数据报的最终目的地址；( 2)由外出接口(outgoing interface)相对应的I P地址取代刚才使用的源地址；( 3)指针加4。

![image-20200906122545059](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906122545059.png)

TCP客户必须能指明源站选路，同时，TCP服务器必须能够接收源站选路，并且对于该TCP连接的所有报文段都能采用反向路由。如果TCP服务器下面接收到一个不同的源站选路，那么新的源站路由将取代旧的源站路由。

宽松的源站选路：下一跳路由符合目的路由就可以，

严格的源站选路：必须是直连路由

### IP选路

- 选路是IP最重要的功能之一。
- 我们还描述了一个路由守护程序（daemon），通常这是一个用户进程。
- 在Unix系统中，大多数普通的守护程序都是路由程序和网关程序
- 路由表经常被IP访问，但是它被路由守护程序更新的频度却要低得多。
- 当接收到ICMP重定向报文时，路由表也要被更新。
- 我们还将用netstat命令来显示路由表。

![image-20200906123212449](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906123212449.png)

##### 选路的原理

我们列出了I P搜索路由表的几个步骤：

1) 搜索匹配的主机地址；

2) 搜索匹配的网络地址；

3) 搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为0）。

匹配主机地址步骤始终发生在匹配网络地址步骤之前。

IP执行选路机制，而路由守护程序则一般提供选路策略。

##### 初始化路由表

每当初始化一个接口时（通常是用ifconfig命令设置接口地址），就为接口自动创建一个直接路由。对于点对点链路和环回接口来说，路由是到达主机（例如，设置 H标志）。对于广播接口来说，如以太网，路由是到达网络。

到达主机或网络的路由如果不是直接相连的，那么就必须加入路由表。

初始化路由表的其他方法是运行路由守护程序或者用较新的路由器发现协议。

##### 没有到达目的地的路由

我们所有的例子都假定对路由表的搜索能找到匹配的表项，即使匹配的是默认项。如果路由表中没有默认项，而又没有找到匹配项，这时会发生什么情况呢？

如果数据报是由本地主机产生的，那么就给发送该数据报的应用程序返回一个差错，或者是“主机不可达差错”或者是“网络不可达差错”。

如果是被转发的数据报，那么就给原始发送端发送一份ICMP主机不可达的差错报文。

##### 转发或不转发

一般都假定主机不转发 I P数据报，除非对它们进行特殊配置而作为路由器使用。

大多数伯克利派生出来的系统都有一个内核变量 ipforwardin 

SunOS 4.1.x允许该变量可以有三个不同的值：

- -1表示始终不转发并且始终不改变它的值； 
- 0表示默认条件下不转发，但是当打开两个或更多个接口时就把该值设为 1；
- 1表示始终转发。

Solaris 2.x把这三个值改为0（始终不转发）、1（始终转发）和2（在打开两个或更多个接口时才转发）。

较早版本的4 . 2 B S D主机在默认条件下可以转发数据报，这给没有进行正确配置的系统带来了许多问题。这就是内核选项为什么要设成默认的“始终不转发”的原因，除非系统管理员进行特殊设置

##### ICMP重定向差错

当I P数据报应该被发送到另一个路由器时，收到数据报的路由器就要发送ICMP重定向差错报文给I P数据报的发送端。只有当主机可以选择路由器发送分组的情况下，我们才可能看到ICMP重定向报文。

1) 我们假定主机发送一份IP数据报给R1。这种选路决策经常发生，因为R1是该主机的默认路由。

2) R1收到数据报并且检查它的路由表，发现R2是发送该数据报的下一站。当它把数据报发送给R2时，R1检测到它正在发送的接口与数据报到达接口是相同的（即主机和两个路由器所在的LAN）。这样就给路由器发送重定向报文给原始发送端提供了线索。

3) R1发送一份ICMP重定向报文给主机，告诉它以后把数据报发送给R2而不是R1。 

![image-20200906124014574](C:\Users\xuyingfeng\AppData\Roaming\Typora\typora-user-images\image-20200906124014574.png)